<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fractal Explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #000;
            cursor: crosshair;
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }

        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px 20px 0 0;
            padding: 20px;
            transform: translateY(calc(100% - 60px));
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.3);
        }

        .controls.expanded {
            transform: translateY(0);
        }

        .controls-handle {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 2px;
            cursor: pointer;
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: white;
        }

        .fractal-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .fractal-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 8px 16px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .fractal-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .fractal-btn.active {
            background: rgba(100, 200, 255, 0.4);
            border-color: rgba(100, 200, 255, 0.6);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-group h3 {
            color: white;
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .slider-container {
            margin-bottom: 10px;
        }

        .slider-container label {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-bottom: 5px;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #64c8ff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .color-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.active {
            border-color: white;
        }

        .info-panel {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.4;
        }

        .zoom-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .preset-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .preset-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 4px 8px;
            color: white;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .shortcuts-help .key {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
        }

        /* Save/Share System */
        .share-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            max-width: 400px;
            width: 90%;
        }

        .share-panel.visible {
            opacity: 1;
            pointer-events: all;
        }

        .share-panel h3 {
            margin: 0 0 15px 0;
            color: #64c8ff;
        }

        .share-url {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            color: white;
            font-family: monospace;
            font-size: 12px;
            width: 100%;
            margin-bottom: 15px;
            word-break: break-all;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .share-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .share-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* Screenshot/Export */
        .export-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            max-width: 350px;
            width: 90%;
        }

        .export-panel.visible {
            opacity: 1;
            pointer-events: all;
        }

        .export-options {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }

        .export-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .export-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .export-option input[type="radio"] {
            accent-color: #64c8ff;
        }

        /* Performance Settings */
        .performance-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .performance-indicator.visible {
            opacity: 1;
        }

        /* Fractal History */
        .history-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .history-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .history-btn:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .history-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Advanced Math Controls */
        .math-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 15px;
        }

        .math-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 8px;
            color: white;
            font-family: monospace;
            font-size: 12px;
            width: 100%;
            margin-bottom: 10px;
        }

        .math-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .complex-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 8px;
            font-family: monospace;
            font-size: 11px;
            color: #64c8ff;
            margin-top: 10px;
        }

        /* 3D Navigation */
        .mandelbulb-3d-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .view-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .view-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 4px 8px;
            color: white;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s ease;
        }

        .view-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .view-btn.active {
            background: rgba(100, 200, 255, 0.4);
            border-color: rgba(100, 200, 255, 0.6);
        }

        /* Overlay backdrop */
        .overlay-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .overlay-backdrop.visible {
            opacity: 1;
            pointer-events: all;
        }
    </style>
</head>
<body>
    <canvas id="fractalCanvas"></canvas>
    
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div class="loading-text">Rendering fractal...</div>
        </div>
    </div>
    
    <!-- Full-screen button -->
    <button class="fullscreen-btn" onclick="toggleFullscreen()" id="fullscreenBtn">⛶ Fullscreen</button>
    
    <!-- Performance indicator -->
    <div class="performance-indicator" id="performanceIndicator">
        Performance: <span id="performanceLevel">High</span>
    </div>
    
    <!-- Fractal history controls -->
    <div class="history-controls">
        <button class="history-btn" onclick="goBack()" id="backBtn">← Back</button>
        <button class="history-btn" onclick="goForward()" id="forwardBtn">Forward →</button>
    </div>
    
    <!-- Share panel -->
    <div class="overlay-backdrop" id="overlayBackdrop" onclick="closeAllPanels()"></div>
    <div class="share-panel" id="sharePanel">
        <h3>Share Fractal View</h3>
        <input type="text" class="share-url" id="shareUrl" readonly>
        <div class="share-buttons">
            <button class="share-btn" onclick="copyShareUrl()">📋 Copy URL</button>
            <button class="share-btn" onclick="shareOnTwitter()">🐦 Twitter</button>
            <button class="share-btn" onclick="shareOnFacebook()">📘 Facebook</button>
            <button class="share-btn" onclick="closeSharePanel()">✕ Close</button>
        </div>
    </div>
    
    <!-- Export panel -->
    <div class="export-panel" id="exportPanel">
        <h3>Export Fractal</h3>
        <div class="export-options">
            <label class="export-option">
                <input type="radio" name="exportFormat" value="png" checked>
                PNG Image (High Quality)
            </label>
            <label class="export-option">
                <input type="radio" name="exportFormat" value="jpg">
                JPEG Image (Smaller Size)
            </label>
            <label class="export-option">
                <input type="radio" name="exportFormat" value="svg">
                SVG Vector (Scalable)
            </label>
        </div>
        <div class="share-buttons">
            <button class="share-btn" onclick="exportFractal()">💾 Export</button>
            <button class="share-btn" onclick="closeExportPanel()">✕ Close</button>
        </div>
    </div>
    
    <!-- Keyboard shortcuts help -->
    <div class="shortcuts-help" id="shortcutsHelp">
        <h4>Keyboard Shortcuts</h4>
        <ul>
            <li><span class="key">R</span> - Reset view</li>
            <li><span class="key">Space</span> - Stop animations</li>
            <li><span class="key">F</span> - Toggle fullscreen</li>
            <li><span class="key">S</span> - Save/Share</li>
            <li><span class="key">E</span> - Export screenshot</li>
            <li><span class="key">?</span> - Show/hide this help</li>
            <li><span class="key">Click</span> - Center view</li>
            <li><span class="key">Scroll</span> - Zoom in/out</li>
        </ul>
    </div>
    
    <div class="zoom-info">
        <div>Zoom: <span id="zoomLevel">1.0x</span></div>
        <div>Center: <span id="centerCoords">0.0, 0.0</span></div>
    </div>

    <div class="controls" id="controls">
        <div class="controls-handle" onclick="toggleControls()"></div>
        
        <div class="controls-header">
            <h2>Fractal Explorer</h2>
            <button onclick="resetView()" class="preset-btn">Reset View</button>
        </div>

        <div class="fractal-selector">
            <button class="fractal-btn active" onclick="selectFractal('mandelbrot')">Mandelbrot Set</button>
            <button class="fractal-btn" onclick="selectFractal('julia')">Julia Set</button>
            <button class="fractal-btn" onclick="selectFractal('burning-ship')">Burning Ship</button>
            <button class="fractal-btn" onclick="selectFractal('mandelbulb')">3D Mandelbulb</button>
            <button class="fractal-btn" onclick="selectFractal('newton')">Newton's Method</button>
            <button class="fractal-btn" onclick="selectFractal('sierpinski')">Sierpinski</button>
            <button class="fractal-btn" onclick="selectFractal('dragon')">Dragon Curve</button>
        </div>

        <div class="controls-grid">
            <div class="control-group">
                <h3>Parameters</h3>
                <div class="slider-container">
                    <label>Iterations: <span id="iterValue">100</span></label>
                    <input type="range" class="slider" id="iterations" min="50" max="500" value="100" oninput="updateParameter('iterations', this.value)">
                </div>
                <div class="slider-container">
                    <label>Escape Radius: <span id="escapeValue">2.0</span></label>
                    <input type="range" class="slider" id="escapeRadius" min="2" max="10" step="0.1" value="2" oninput="updateParameter('escapeRadius', this.value)">
                </div>
                <div id="juliaControls" style="display: none;">
                    <div class="slider-container">
                        <label>Julia C Real: <span id="juliaCRealValue">-0.7</span></label>
                        <input type="range" class="slider" id="juliaCReal" min="-2" max="2" step="0.01" value="-0.7" oninput="updateParameter('juliaCReal', this.value)">
                    </div>
                    <div class="slider-container">
                        <label>Julia C Imaginary: <span id="juliaCImagValue">0.27015</span></label>
                        <input type="range" class="slider" id="juliaCImag" min="-2" max="2" step="0.01" value="0.27015" oninput="updateParameter('juliaCImag', this.value)">
                    </div>
                </div>
                <div id="mandelbulbControls" style="display: none;">
                    <div class="slider-container">
                        <label>Power: <span id="powerValue">8</span></label>
                        <input type="range" class="slider" id="power" min="2" max="20" step="1" value="8" oninput="updateParameter('power', this.value)">
                    </div>
                    <div class="slider-container">
                        <label>Slice Z: <span id="sliceZValue">0.0</span></label>
                        <input type="range" class="slider" id="sliceZ" min="-2" max="2" step="0.01" value="0" oninput="updateParameter('sliceZ', this.value)">
                    </div>
                </div>
            </div>

            <div class="control-group">
                <h3>Motion Animations</h3>
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="startAnimation('zoom')" id="zoomAnimBtn">Auto Zoom</button>
                    <button class="preset-btn" onclick="startAnimation('rotate')" id="rotateAnimBtn">Orbit</button>
                    <button class="preset-btn" onclick="startAnimation('julia')" id="juliaAnimBtn">Julia Morph</button>
                    <button class="preset-btn" onclick="startAnimation('spiral')" id="spiralAnimBtn">Spiral Zoom</button>
                </div>
                <div class="slider-container">
                    <label>Motion Speed: <span id="animSpeedValue">1.0</span></label>
                    <input type="range" class="slider" id="animSpeed" min="0.1" max="3.0" step="0.1" value="1.0" oninput="updateAnimSpeed(this.value)">
                </div>
            </div>

            <div class="control-group">
                <h3>Color Animations</h3>
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="startColorAnimation('shift')" id="shiftColorBtn">Color Shift</button>
                    <button class="preset-btn" onclick="startColorAnimation('pulse')" id="pulseColorBtn">Color Pulse</button>
                    <button class="preset-btn" onclick="startColorAnimation('wave')" id="waveColorBtn">Color Wave</button>
                    <button class="preset-btn" onclick="startColorAnimation('strobe')" id="strobeColorBtn">Strobe</button>
                </div>
                <div class="slider-container">
                    <label>Color Speed: <span id="colorSpeedValue">1.0</span></label>
                    <input type="range" class="slider" id="colorSpeed" min="0.1" max="5.0" step="0.1" value="1.0" oninput="updateColorSpeed(this.value)">
                </div>
                <div class="slider-container">
                    <label>Color Intensity: <span id="colorIntensityValue">1.0</span></label>
                    <input type="range" class="slider" id="colorIntensity" min="0.1" max="3.0" step="0.1" value="1.0" oninput="updateColorIntensity(this.value)">
                </div>
            </div>

            <div class="control-group">
                <h3>Color Schemes & Presets</h3>
                <div class="color-picker">
                    <div class="color-option active" style="background: linear-gradient(45deg, #ff0080, #0080ff, #80ff00)" onclick="selectColorScheme('rainbow')"></div>
                    <div class="color-option" style="background: linear-gradient(45deg, #ff4500, #ff8c00, #ffd700)" onclick="selectColorScheme('fire')"></div>
                    <div class="color-option" style="background: linear-gradient(45deg, #000080, #4169e1, #87ceeb)" onclick="selectColorScheme('ocean')"></div>
                    <div class="color-option" style="background: linear-gradient(45deg, #4b0082, #8b00ff, #da70d6)" onclick="selectColorScheme('purple')"></div>
                    <div class="color-option" style="background: linear-gradient(45deg, #00ff00, #00ffff, #ff00ff)" onclick="selectColorScheme('neon')"></div>
                    <div class="color-option" style="background: linear-gradient(45deg, #8b4513, #daa520, #f4a460)" onclick="selectColorScheme('vintage')"></div>
                    <div class="color-option" style="background: linear-gradient(45deg, #000033, #660066, #ff0066)" onclick="selectColorScheme('cosmic')"></div>
                    <div class="color-option" style="background: linear-gradient(45deg, #000, #444, #fff)" onclick="selectColorScheme('mono')"></div>
                </div>
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="goToPreset('spiral')">Spiral</button>
                    <button class="preset-btn" onclick="goToPreset('seahorse')">Seahorse</button>
                    <button class="preset-btn" onclick="goToPreset('elephant')">Elephant</button>
                    <button class="preset-btn" onclick="goToPreset('lightning')">Lightning</button>
                    <button class="preset-btn" onclick="goToRandomLocation()" style="background: linear-gradient(45deg, #ff6b6b, #4ecdc4);">🎲 Random</button>
                </div>
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="stopAllAnimations()" id="stopAllBtn">Stop All Animations</button>
                </div>
            </div>

            <div class="control-group">
                <h3>Save & Export</h3>
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="openSharePanel()">📤 Share View</button>
                    <button class="preset-btn" onclick="openExportPanel()">💾 Export Image</button>
                </div>
                <div class="slider-container">
                    <label>Performance Quality: <span id="qualityValue">High</span></label>
                    <input type="range" class="slider" id="performanceQuality" min="1" max="3" step="1" value="3" oninput="updatePerformanceQuality(this.value)">
                </div>
            </div>

            <div class="control-group">
                <h3>Advanced Math</h3>
                <div class="math-panel" id="mathPanel">
                    <div class="slider-container">
                        <label>Custom Julia C Real: <span id="customJuliaRealValue">-0.7</span></label>
                        <input type="text" class="math-input" id="customJuliaReal" placeholder="Enter real part (e.g., -0.7)" onchange="updateCustomJulia()">
                    </div>
                    <div class="slider-container">
                        <label>Custom Julia C Imaginary: <span id="customJuliaImagValue">0.27015</span></label>
                        <input type="text" class="math-input" id="customJuliaImag" placeholder="Enter imaginary part (e.g., 0.27015)" onchange="updateCustomJulia()">
                    </div>
                    <div class="complex-display" id="complexDisplay">
                        Current: c = -0.7 + 0.27015i
                    </div>
                </div>
                <div id="mandelbulb3dControls" style="display: none;">
                    <div class="mandelbulb-3d-controls">
                        <div class="slider-container">
                            <label>Rotation X: <span id="rotXValue">0°</span></label>
                            <input type="range" class="slider" id="rotX" min="0" max="360" value="0" oninput="update3DRotation()">
                        </div>
                        <div class="slider-container">
                            <label>Rotation Y: <span id="rotYValue">0°</span></label>
                            <input type="range" class="slider" id="rotY" min="0" max="360" value="0" oninput="update3DRotation()">
                        </div>
                    </div>
                    <div class="view-controls">
                        <button class="view-btn active" onclick="set3DView('xy')">XY Plane</button>
                        <button class="view-btn" onclick="set3DView('xz')">XZ Plane</button>
                        <button class="view-btn" onclick="set3DView('yz')">YZ Plane</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-panel" id="fractalInfo">
            <strong>Mandelbrot Set:</strong> The most famous fractal, discovered by Benoit Mandelbrot. It's the set of complex numbers c for which the function f(z) = z² + c does not diverge when iterated from z = 0. The boundary of this set creates the intricate patterns you see, with infinite detail at every level of magnification.
        </div>
    </div>

    <script>
        // ===== CANVAS SETUP =====
        const canvas = document.getElementById('fractalCanvas');
        const ctx = canvas.getContext('2d');
        
        // ===== FRACTAL PARAMETERS =====
        let fractalType = 'mandelbrot';        // Currently selected fractal type
        let maxIterations = 100;               // Maximum iterations before considering a point as in the set
        let escapeRadius = 2.0;               // Radius beyond which a point is considered to escape
        let colorScheme = 'rainbow';          // Current color scheme for rendering
        
        // Julia set specific parameters
        let juliaCReal = -0.7;                // Real component of Julia set constant c
        let juliaCImag = 0.27015;             // Imaginary component of Julia set constant c
        
        // Mandelbulb specific parameters (3D fractal rendered as 2D slice)
        let bulbPower = 8;                    // Power parameter for Mandelbulb calculation
        let sliceZ = 0;                       // Z-axis slice position for 3D Mandelbulb
        
        // ===== VIEW AND NAVIGATION PARAMETERS =====
        let centerX = 0;                      // X coordinate of viewport center
        let centerY = 0;                      // Y coordinate of viewport center
        let zoom = 1;                         // Current zoom level
        let scale = 4;                        // Base scale factor for coordinate mapping
        
        // ===== ANIMATION PARAMETERS =====
        let animationType = null;             // Current motion animation type
        let colorAnimationType = null;        // Current color animation type
        let animationSpeed = 1.0;            // Speed multiplier for motion animations
        let colorAnimationSpeed = 1.0;       // Speed multiplier for color animations
        let colorIntensity = 1.0;            // Intensity multiplier for color effects
        let animationFrame = 0;              // Frame counter for motion animations
        let colorAnimationFrame = 0;         // Frame counter for color animations
        let animationId = null;              // RequestAnimationFrame ID for stopping animations
        
        // ===== NEW FEATURE PARAMETERS =====
        let isFullscreen = false;             // Full-screen mode state
        let isLoading = false;                // Loading state
        let shortcutsVisible = false;         // Keyboard shortcuts help visibility
        let lastColorScheme = 'rainbow';      // Previous color scheme for smooth transitions
        
        // ===== INTERMEDIATE FEATURE PARAMETERS =====
        let fractalHistory = [];              // Array to store fractal view history
        let historyIndex = -1;                // Current position in history
        let performanceQuality = 3;           // Performance quality level (1-3)
        let sharePanelVisible = false;        // Share panel visibility
        let exportPanelVisible = false;       // Export panel visibility
        
        // ===== ADVANCED MATH PARAMETERS =====
        let customJuliaReal = -0.7;           // Custom Julia real component
        let customJuliaImag = 0.27015;        // Custom Julia imaginary component
        let rotX = 0;                         // 3D rotation X angle
        let rotY = 0;                         // 3D rotation Y angle
        let current3DView = 'xy';             // Current 3D view plane
        
        // ===== CANVAS MANAGEMENT =====
        function resizeCanvas() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            canvas.width = width;
            canvas.height = height;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            
            if (canvas.width > 0 && canvas.height > 0) {
                renderFractal();
            }
        }
        
        // ===== FRACTAL CALCULATION FUNCTIONS =====
        function mandelbrot(x, y) {
            let real = x;
            let imag = y;
            let realTemp;
            
            for (let i = 0; i < maxIterations; i++) {
                if (real * real + imag * imag > escapeRadius * escapeRadius) {
                    return i;
                }
                realTemp = real * real - imag * imag + x;
                imag = 2 * real * imag + y;
                real = realTemp;
            }
            return maxIterations;
        }
        
        function julia(x, y) {
            let real = x;
            let imag = y;
            let realTemp;
            
            for (let i = 0; i < maxIterations; i++) {
                if (real * real + imag * imag > escapeRadius * escapeRadius) {
                    return i;
                }
                realTemp = real * real - imag * imag + juliaCReal;
                imag = 2 * real * imag + juliaCImag;
                real = realTemp;
            }
            return maxIterations;
        }
        
        function burningShip(x, y) {
            let real = x;
            let imag = y;
            let realTemp;
            
            for (let i = 0; i < maxIterations; i++) {
                if (real * real + imag * imag > escapeRadius * escapeRadius) {
                    return i;
                }
                realTemp = real * real - imag * imag + x;
                imag = 2 * Math.abs(real * imag) + y;
                real = Math.abs(realTemp);
            }
            return maxIterations;
        }
        
        function mandelbulb(x, y, z) {
            let px = x, py = y, pz = z;
            let r = 0.0;
            
            for (let i = 0; i < maxIterations; i++) {
                r = Math.sqrt(px*px + py*py + pz*pz);
                if (r > escapeRadius) return i;
                
                let theta = Math.acos(pz/r);
                let phi = Math.atan2(py, px);
                
                let zr = Math.pow(r, bulbPower);
                theta = theta * bulbPower;
                phi = phi * bulbPower;
                
                px = zr * Math.sin(theta) * Math.cos(phi) + x;
                py = zr * Math.sin(phi) * Math.sin(theta) + y;
                pz = zr * Math.cos(theta) + z;
            }
            return maxIterations;
        }
        
        function newton(x, y) {
            let zx = x;
            let zy = y;
            
            for (let i = 0; i < maxIterations; i++) {
                let zx3 = zx*zx*zx - 3*zx*zy*zy;
                let zy3 = 3*zx*zx*zy - zy*zy*zy;
                
                let dx = 3*(zx*zx - zy*zy);
                let dy = 6*zx*zy;
                
                let denominator = dx*dx + dy*dy;
                if (denominator < 1e-10) return i;
                
                let fx = zx3 - 1;
                let fy = zy3;
                
                let newZx = zx - (fx*dx + fy*dy) / denominator;
                let newZy = zy - (fy*dx - fx*dy) / denominator;
                
                if (Math.abs(newZx - zx) + Math.abs(newZy - zy) < 1e-6) return i;
                
                zx = newZx;
                zy = newZy;
            }
            return maxIterations;
        }
        
        function sierpinski(x, y) {
            // Sierpinski triangle using chaos game method
            let px = x * 2 + 1;
            let py = y * 2 + 1;
            
            for (let i = 0; i < maxIterations; i++) {
                let r = Math.random();
                if (r < 0.33) {
                    px = px * 0.5;
                    py = py * 0.5;
                } else if (r < 0.66) {
                    px = px * 0.5 + 0.5;
                    py = py * 0.5;
                } else {
                    px = px * 0.5 + 0.25;
                    py = py * 0.5 + 0.5;
                }
                
                if (px < 0 || px > 1 || py < 0 || py > 1) return i;
            }
            return maxIterations;
        }
        
        function dragonCurve(x, y) {
            // Dragon curve using L-system approximation
            let px = x * 4 - 2;
            let py = y * 4 - 2;
            
            for (let i = 0; i < maxIterations; i++) {
                let angle = i * Math.PI / 4;
                let scale = Math.pow(0.707, i);
                
                let newX = px * Math.cos(angle) - py * Math.sin(angle);
                let newY = px * Math.sin(angle) + py * Math.cos(angle);
                
                px = newX * scale;
                py = newY * scale;
                
                if (Math.abs(px) > 2 || Math.abs(py) > 2) return i;
            }
            return maxIterations;
        }
        
        function getFractalIterations(type, x, y) {
            switch (type) {
                case 'mandelbrot':
                    return mandelbrot(x, y);
                case 'julia':
                    return julia(x, y);
                case 'burning-ship':
                    return burningShip(x, y);
                case 'mandelbulb':
                    return mandelbulb(x, y, sliceZ);
                case 'newton':
                    return newton(x, y);
                case 'sierpinski':
                    return sierpinski(x, y);
                case 'dragon':
                    return dragonCurve(x, y);
                default:
                    return mandelbrot(x, y);
            }
        }
        
        // ===== COLOR CALCULATION =====
        function getColor(iterations) {
            if (iterations === maxIterations) return [0, 0, 0];
            
            let t = iterations / maxIterations;
            
            if (colorAnimationType) {
                const colorTime = colorAnimationFrame * colorAnimationSpeed * 0.01;
                switch (colorAnimationType) {
                    case 'shift':
                        t = (t + colorTime) % 1;
                        break;
                    case 'pulse':
                        t = t * (0.5 + 0.5 * Math.sin(colorTime * 2));
                        break;
                    case 'wave':
                        t = t + 0.3 * Math.sin(colorTime + t * 10);
                        break;
                    case 'strobe':
                        t = t * (Math.sin(colorTime * 10) > 0 ? colorIntensity : 0.1);
                        break;
                }
                t = Math.max(0, Math.min(1, t * colorIntensity));
            }
            
            switch (colorScheme) {
                case 'rainbow':
                    return [
                        Math.floor(255 * (0.5 + 0.5 * Math.sin(3 * t + 0))),
                        Math.floor(255 * (0.5 + 0.5 * Math.sin(3 * t + 2))),
                        Math.floor(255 * (0.5 + 0.5 * Math.sin(3 * t + 4)))
                    ];
                case 'fire':
                    return [
                        Math.floor(255 * Math.min(1, 2 * t)),
                        Math.floor(255 * Math.max(0, 2 * t - 0.5)),
                        Math.floor(255 * Math.max(0, 4 * t - 3))
                    ];
                case 'ocean':
                    return [
                        Math.floor(255 * t * 0.3),
                        Math.floor(255 * t * 0.7),
                        Math.floor(255 * Math.min(1, t * 1.5))
                    ];
                case 'purple':
                    return [
                        Math.floor(255 * t),
                        Math.floor(255 * t * 0.3),
                        Math.floor(255 * Math.min(1, t * 1.2))
                    ];
                case 'mono':
                    const intensity = Math.floor(255 * t);
                    return [intensity, intensity, intensity];
                default:
                    return [255, 255, 255];
            }
        }
        
        // ===== MAIN RENDERING FUNCTION =====
        function renderFractal() {
            if (!canvas.width || !canvas.height || canvas.width <= 0 || canvas.height <= 0) {
                setTimeout(renderFractal, 100);
                return;
            }
            
            const imageData = ctx.createImageData(canvas.width, canvas.height);
            const data = imageData.data;
            
            const aspectRatio = canvas.width / canvas.height;
            const zoomScale = scale / zoom;
            
            for (let px = 0; px < canvas.width; px++) {
                for (let py = 0; py < canvas.height; py++) {
                    const x = centerX + (px - canvas.width / 2) / canvas.width * zoomScale * aspectRatio;
                    const y = centerY - (py - canvas.height / 2) / canvas.height * zoomScale;
                    
                    let iterations = getFractalIterations(fractalType, x, y);
                    
                    const [r, g, b] = getColor(iterations);
                    const index = (py * canvas.width + px) * 4;
                    
                    data[index] = r;
                    data[index + 1] = g;
                    data[index + 2] = b;
                    data[index + 3] = 255;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            updateZoomInfo();
        }
        
        // ===== UI UPDATE FUNCTIONS =====
        function updateZoomInfo() {
            document.getElementById('zoomLevel').textContent = zoom.toFixed(1) + 'x';
            document.getElementById('centerCoords').textContent = 
                centerX.toFixed(6) + ', ' + centerY.toFixed(6);
        }
        
        function selectFractal(type) {
            fractalType = type;
            
            document.querySelectorAll('.fractal-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const juliaControls = document.getElementById('juliaControls');
            const mandelbulbControls = document.getElementById('mandelbulbControls');
            const mandelbulb3dControls = document.getElementById('mandelbulb3dControls');
            const mathPanel = document.getElementById('mathPanel');
            
            juliaControls.style.display = type === 'julia' ? 'block' : 'none';
            mandelbulbControls.style.display = type === 'mandelbulb' ? 'block' : 'none';
            mandelbulb3dControls.style.display = type === 'mandelbulb' ? 'block' : 'none';
            mathPanel.style.display = (type === 'julia' || type === 'mandelbulb') ? 'block' : 'none';
            
            updateFractalInfo(type);
            renderFractal();
        }
        
        function updateFractalInfo(type) {
            const info = {
                'mandelbrot': '<strong>Mandelbrot Set:</strong> The most famous fractal, discovered by Benoit Mandelbrot. It\'s the set of complex numbers c for which the function f(z) = z² + c does not diverge when iterated from z = 0.',
                'julia': '<strong>Julia Set:</strong> Named after Gaston Julia, these fractals are generated by iterating f(z) = z² + c, but starting with different initial values. The constant c determines the shape.',
                'burning-ship': '<strong>Burning Ship:</strong> A variation of the Mandelbrot set where the absolute value is taken at each iteration, creating ship-like structures.',
                'mandelbulb': '<strong>3D Mandelbulb:</strong> A three-dimensional analog of the Mandelbrot set. You\'re viewing a 2D cross-section through the 3D structure. Adjust the Slice Z to explore different layers.',
                'newton': '<strong>Newton\'s Method:</strong> Visualizes the convergence behavior of Newton\'s root-finding method for the polynomial z³ - 1 = 0, showing basins of attraction.',
                'sierpinski': '<strong>Sierpinski Triangle:</strong> A self-similar fractal created by recursively subdividing a triangle. This implementation uses the chaos game method to generate the pattern.',
                'dragon': '<strong>Dragon Curve:</strong> A space-filling curve that can be constructed by folding a strip of paper. This fractal shows the self-similar structure of the dragon curve.'
            };
            
            document.getElementById('fractalInfo').innerHTML = info[type];
        }
        
        function updateParameter(param, value) {
            switch (param) {
                case 'iterations':
                    maxIterations = parseInt(value);
                    document.getElementById('iterValue').textContent = value;
                    break;
                case 'escapeRadius':
                    escapeRadius = parseFloat(value);
                    document.getElementById('escapeValue').textContent = value;
                    break;
                case 'juliaCReal':
                    juliaCReal = parseFloat(value);
                    document.getElementById('juliaCRealValue').textContent = value;
                    break;
                case 'juliaCImag':
                    juliaCImag = parseFloat(value);
                    document.getElementById('juliaCImagValue').textContent = value;
                    break;
                case 'power':
                    bulbPower = parseInt(value);
                    document.getElementById('powerValue').textContent = value;
                    break;
                case 'sliceZ':
                    sliceZ = parseFloat(value);
                    document.getElementById('sliceZValue').textContent = value;
                    break;
            }
            renderFractal();
        }
        
        function selectColorScheme(scheme) {
            colorScheme = scheme;
            
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
            event.target.classList.add('active');
            
            renderFractal();
        }
        
        function goToPreset(preset) {
            const presets = {
                'spiral': { centerX: -0.8, centerY: 0.156, zoom: 100 },
                'seahorse': { centerX: -0.75, centerY: 0.1, zoom: 200 },
                'elephant': { centerX: 0.257, centerY: 0.0, zoom: 300 },
                'lightning': { centerX: -1.775, centerY: 0.0, zoom: 150 }
            };
            
            if (presets[preset]) {
                centerX = presets[preset].centerX;
                centerY = presets[preset].centerY;
                zoom = presets[preset].zoom;
                renderFractal();
            }
        }
        
        function resetView() {
            centerX = 0;
            centerY = 0;
            zoom = 1;
            renderFractal();
        }
        
        // ===== ANIMATION FUNCTIONS =====
        function startAnimation(type) {
            animationType = type;
            animationFrame = 0;
            
            document.querySelectorAll('#zoomAnimBtn, #rotateAnimBtn, #juliaAnimBtn, #spiralAnimBtn').forEach(btn => 
                btn.style.background = 'rgba(255, 255, 255, 0.1)');
            document.getElementById(type + 'AnimBtn').style.background = 'rgba(100, 200, 255, 0.4)';
            
            if (!animationId) animate();
        }
        
        function startColorAnimation(type) {
            colorAnimationType = type;
            colorAnimationFrame = 0;
            
            document.querySelectorAll('#shiftColorBtn, #pulseColorBtn, #waveColorBtn, #strobeColorBtn').forEach(btn => 
                btn.style.background = 'rgba(255, 255, 255, 0.1)');
            document.getElementById(type + 'ColorBtn').style.background = 'rgba(100, 200, 255, 0.4)';
            
            if (!animationId) animate();
        }
        
        function stopAllAnimations() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            animationType = null;
            colorAnimationType = null;
            
            document.querySelectorAll('.preset-btn').forEach(btn => btn.style.background = 'rgba(255, 255, 255, 0.1)');
        }
        
        function animate() {
            if (!animationType && !colorAnimationType) {
                animationId = null;
                return;
            }
            
            if (animationType) {
                animationFrame += animationSpeed;
                
                switch (animationType) {
                    case 'zoom':
                        zoom *= 1.02;
                        if (zoom > 1000) animationType = null;
                        break;
                        
                    case 'rotate':
                        const angle = animationFrame * 0.02;
                        centerX = 0.3 * Math.cos(angle);
                        centerY = 0.3 * Math.sin(angle);
                        break;
                        
                    case 'julia':
                        if (fractalType === 'julia') {
                            juliaCReal = 0.7 * Math.cos(animationFrame * 0.05);
                            juliaCImag = 0.7 * Math.sin(animationFrame * 0.03);
                            document.getElementById('juliaCReal').value = juliaCReal;
                            document.getElementById('juliaCImag').value = juliaCImag;
                            document.getElementById('juliaCRealValue').textContent = juliaCReal.toFixed(2);
                            document.getElementById('juliaCImagValue').textContent = juliaCImag.toFixed(2);
                        }
                        break;
                        
                    case 'spiral':
                        const spiralAngle = animationFrame * 0.05;
                        const spiralRadius = animationFrame * 0.001;
                        centerX = spiralRadius * Math.cos(spiralAngle);
                        centerY = spiralRadius * Math.sin(spiralAngle);
                        zoom *= 1.01;
                        if (zoom > 500) animationType = null;
                        break;
                }
            }
            
            if (colorAnimationType) {
                colorAnimationFrame += colorAnimationSpeed;
            }
            
            renderFractal();
            animationId = requestAnimationFrame(animate);
        }
        
        function updateAnimSpeed(value) {
            animationSpeed = parseFloat(value);
            document.getElementById('animSpeedValue').textContent = value;
        }
        
        function updateColorSpeed(value) {
            colorAnimationSpeed = parseFloat(value);
            document.getElementById('colorSpeedValue').textContent = value;
        }
        
        function updateColorIntensity(value) {
            colorIntensity = parseFloat(value);
            document.getElementById('colorIntensityValue').textContent = value;
        }
        
        function toggleControls() {
            const controls = document.getElementById('controls');
            controls.classList.toggle('expanded');
        }
        
        function showControls() {
            const controls = document.getElementById('controls');
            controls.classList.add('expanded');
        }
        
        function hideControls() {
            const controls = document.getElementById('controls');
            controls.classList.remove('expanded');
        }
        
        // ===== NEW FEATURE FUNCTIONS =====
        
        function toggleFullscreen() {
            isFullscreen = !isFullscreen;
            document.body.classList.toggle('fullscreen-mode', isFullscreen);
            
            const btn = document.getElementById('fullscreenBtn');
            if (isFullscreen) {
                btn.textContent = '⛶ Exit Fullscreen';
                btn.style.background = 'rgba(255, 255, 255, 0.2)';
            } else {
                btn.textContent = '⛶ Fullscreen';
                btn.style.background = 'rgba(0, 0, 0, 0.7)';
            }
        }
        
        function goToRandomLocation() {
            const randomLocations = [
                { centerX: -0.8, centerY: 0.156, zoom: 100, name: 'Spiral Valley' },
                { centerX: -0.75, centerY: 0.1, zoom: 200, name: 'Seahorse Valley' },
                { centerX: 0.257, centerY: 0.0, zoom: 300, name: 'Elephant Valley' },
                { centerX: -1.775, centerY: 0.0, zoom: 150, name: 'Lightning Bolt' },
                { centerX: -0.5, centerY: 0.5, zoom: 50, name: 'Mountain Range' },
                { centerX: 0.285, centerY: 0.01, zoom: 400, name: 'Deep Valley' },
                { centerX: -0.1, centerY: 0.8, zoom: 80, name: 'Northern Lights' },
                { centerX: 0.4, centerY: -0.3, zoom: 120, name: 'Southern Cross' }
            ];
            
            const randomLocation = randomLocations[Math.floor(Math.random() * randomLocations.length)];
            centerX = randomLocation.centerX;
            centerY = randomLocation.centerY;
            zoom = randomLocation.zoom;
            
            // Also randomize color scheme
            const colorSchemes = ['rainbow', 'fire', 'ocean', 'purple', 'neon', 'vintage', 'cosmic'];
            const randomColor = colorSchemes[Math.floor(Math.random() * colorSchemes.length)];
            selectColorScheme(randomColor);
            
            renderFractal();
        }
        
        function toggleShortcutsHelp() {
            shortcutsVisible = !shortcutsVisible;
            const help = document.getElementById('shortcutsHelp');
            help.classList.toggle('visible', shortcutsVisible);
        }
        
        // ===== INTERMEDIATE FEATURE FUNCTIONS =====
        
        function addToHistory() {
            const currentState = {
                centerX, centerY, zoom, fractalType, colorScheme,
                maxIterations, escapeRadius, juliaCReal, juliaCImag,
                bulbPower, sliceZ, rotX, rotY, current3DView
            };
            
            // Remove any future history if we're not at the end
            fractalHistory = fractalHistory.slice(0, historyIndex + 1);
            fractalHistory.push(currentState);
            historyIndex = fractalHistory.length - 1;
            
            // Limit history size
            if (fractalHistory.length > 50) {
                fractalHistory.shift();
                historyIndex--;
            }
            
            updateHistoryButtons();
        }
        
        function goBack() {
            if (historyIndex > 0) {
                historyIndex--;
                loadFromHistory();
            }
        }
        
        function goForward() {
            if (historyIndex < fractalHistory.length - 1) {
                historyIndex++;
                loadFromHistory();
            }
        }
        
        function loadFromHistory() {
            if (historyIndex >= 0 && historyIndex < fractalHistory.length) {
                const state = fractalHistory[historyIndex];
                centerX = state.centerX;
                centerY = state.centerY;
                zoom = state.zoom;
                fractalType = state.fractalType;
                colorScheme = state.colorScheme;
                maxIterations = state.maxIterations;
                escapeRadius = state.escapeRadius;
                juliaCReal = state.juliaCReal;
                juliaCImag = state.juliaCImag;
                bulbPower = state.bulbPower;
                sliceZ = state.sliceZ;
                rotX = state.rotX;
                rotY = state.rotY;
                current3DView = state.current3DView;
                
                updateUIFromState();
                renderFractal();
            }
        }
        
        function updateHistoryButtons() {
            document.getElementById('backBtn').disabled = historyIndex <= 0;
            document.getElementById('forwardBtn').disabled = historyIndex >= fractalHistory.length - 1;
        }
        
        function updateUIFromState() {
            // Update UI elements to match current state
            document.getElementById('iterations').value = maxIterations;
            document.getElementById('iterValue').textContent = maxIterations;
            document.getElementById('escapeRadius').value = escapeRadius;
            document.getElementById('escapeValue').textContent = escapeRadius;
            
            // Update fractal type buttons
            document.querySelectorAll('.fractal-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="selectFractal('${fractalType}')"]`).classList.add('active');
        }
        
        function openSharePanel() {
            sharePanelVisible = true;
            document.getElementById('sharePanel').classList.add('visible');
            document.getElementById('overlayBackdrop').classList.add('visible');
            
            // Generate share URL
            const shareUrl = generateShareUrl();
            document.getElementById('shareUrl').value = shareUrl;
        }
        
        function closeSharePanel() {
            sharePanelVisible = false;
            document.getElementById('sharePanel').classList.remove('visible');
            document.getElementById('overlayBackdrop').classList.remove('visible');
        }
        
        function generateShareUrl() {
            const params = new URLSearchParams({
                type: fractalType,
                x: centerX.toFixed(6),
                y: centerY.toFixed(6),
                zoom: zoom.toFixed(2),
                color: colorScheme,
                iter: maxIterations,
                escape: escapeRadius.toFixed(1),
                juliaR: juliaCReal.toFixed(6),
                juliaI: juliaCImag.toFixed(6),
                power: bulbPower,
                slice: sliceZ.toFixed(2)
            });
            return window.location.origin + window.location.pathname + '?' + params.toString();
        }
        
        function copyShareUrl() {
            const urlInput = document.getElementById('shareUrl');
            urlInput.select();
            document.execCommand('copy');
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '✓ Copied!';
            setTimeout(() => btn.textContent = originalText, 2000);
        }
        
        function shareOnTwitter() {
            const url = encodeURIComponent(generateShareUrl());
            const text = encodeURIComponent('Check out this amazing fractal I found!');
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
        }
        
        function shareOnFacebook() {
            const url = encodeURIComponent(generateShareUrl());
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
        }
        
        function openExportPanel() {
            exportPanelVisible = true;
            document.getElementById('exportPanel').classList.add('visible');
            document.getElementById('overlayBackdrop').classList.add('visible');
        }
        
        function closeExportPanel() {
            exportPanelVisible = false;
            document.getElementById('exportPanel').classList.remove('visible');
            document.getElementById('overlayBackdrop').classList.remove('visible');
        }
        
        function exportFractal() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            const link = document.createElement('a');
            
            if (format === 'svg') {
                // For SVG, we'd need to implement vector rendering
                alert('SVG export coming soon!');
                return;
            }
            
            // Export as PNG or JPG
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = `fractal-${fractalType}-${Date.now()}.${format}`;
                link.click();
                URL.revokeObjectURL(url);
            }, format === 'jpg' ? 'image/jpeg' : 'image/png', 0.9);
            
            closeExportPanel();
        }
        
        function updatePerformanceQuality(value) {
            performanceQuality = parseInt(value);
            const qualityTexts = ['Low', 'Medium', 'High'];
            document.getElementById('qualityValue').textContent = qualityTexts[value - 1];
            
            // Adjust rendering parameters based on quality
            switch (performanceQuality) {
                case 1: // Low
                    maxIterations = Math.min(maxIterations, 50);
                    break;
                case 2: // Medium
                    maxIterations = Math.min(maxIterations, 150);
                    break;
                case 3: // High
                    maxIterations = Math.min(maxIterations, 500);
                    break;
            }
            
            document.getElementById('iterations').value = maxIterations;
            document.getElementById('iterValue').textContent = maxIterations;
            
            renderFractal();
        }
        
        function closeAllPanels() {
            closeSharePanel();
            closeExportPanel();
        }
        
        // ===== ADVANCED MATH FUNCTIONS =====
        
        function updateCustomJulia() {
            const realInput = document.getElementById('customJuliaReal');
            const imagInput = document.getElementById('customJuliaImag');
            
            const real = parseFloat(realInput.value);
            const imag = parseFloat(imagInput.value);
            
            if (!isNaN(real) && !isNaN(imag)) {
                customJuliaReal = real;
                customJuliaImag = imag;
                juliaCReal = real;
                juliaCImag = imag;
                
                document.getElementById('customJuliaRealValue').textContent = real.toFixed(6);
                document.getElementById('customJuliaImagValue').textContent = imag.toFixed(6);
                document.getElementById('complexDisplay').textContent = `Current: c = ${real.toFixed(6)} + ${imag.toFixed(6)}i`;
                
                renderFractal();
            }
        }
        
        function update3DRotation() {
            rotX = parseInt(document.getElementById('rotX').value);
            rotY = parseInt(document.getElementById('rotY').value);
            
            document.getElementById('rotXValue').textContent = rotX + '°';
            document.getElementById('rotYValue').textContent = rotY + '°';
            
            renderFractal();
        }
        
        function set3DView(plane) {
            current3DView = plane;
            
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderFractal();
        }
        
        // ===== EVENT LISTENERS =====
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            switch (e.key.toLowerCase()) {
                case 'r':
                    e.preventDefault();
                    resetView();
                    break;
                case ' ':
                    e.preventDefault();
                    stopAllAnimations();
                    break;
                case 'f':
                    e.preventDefault();
                    toggleFullscreen();
                    break;
                case 's':
                    e.preventDefault();
                    openSharePanel();
                    break;
                case 'e':
                    e.preventDefault();
                    openExportPanel();
                    break;
                case '?':
                    e.preventDefault();
                    toggleShortcutsHelp();
                    break;
            }
        });
        
        // Touch events for mobile
        let touchStartX = 0;
        let touchStartY = 0;
        let touchStartTime = 0;
        
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            touchStartTime = Date.now();
        });
        
        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            const touch = e.changedTouches[0];
            const touchEndTime = Date.now();
            const touchDuration = touchEndTime - touchStartTime;
            
            // If it's a quick tap (less than 200ms), treat as click
            if (touchDuration < 200) {
                const rect = canvas.getBoundingClientRect();
                const clickX = touch.clientX - rect.left;
                const clickY = touch.clientY - rect.top;
                
                const aspectRatio = canvas.width / canvas.height;
                const zoomScale = scale / zoom;
                
                const newCenterX = centerX + (clickX - canvas.width / 2) / canvas.width * zoomScale * aspectRatio;
                const newCenterY = centerY - (clickY - canvas.height / 2) / canvas.height * zoomScale;
                
                centerX = newCenterX;
                centerY = newCenterY;
                
                renderFractal();
            }
        });
        
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;
            
            const aspectRatio = canvas.width / canvas.height;
            const zoomScale = scale / zoom;
            
            const newCenterX = centerX + (clickX - canvas.width / 2) / canvas.width * zoomScale * aspectRatio;
            const newCenterY = centerY - (clickY - canvas.height / 2) / canvas.height * zoomScale;
            
            centerX = newCenterX;
            centerY = newCenterY;
            
            renderFractal();
        });
        
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            zoom *= zoomFactor;
            zoom = Math.max(0.1, Math.min(zoom, 1000));
            
            renderFractal();
        });
        
        const controls = document.getElementById('controls');
        controls.addEventListener('mouseenter', showControls);
        controls.addEventListener('mouseleave', hideControls);
        
        window.addEventListener('resize', resizeCanvas);
        
        // ===== INITIALIZATION =====
        function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.has('type')) {
                fractalType = urlParams.get('type');
                selectFractal(fractalType);
            }
            
            if (urlParams.has('x') && urlParams.has('y')) {
                centerX = parseFloat(urlParams.get('x'));
                centerY = parseFloat(urlParams.get('y'));
            }
            
            if (urlParams.has('zoom')) {
                zoom = parseFloat(urlParams.get('zoom'));
            }
            
            if (urlParams.has('color')) {
                colorScheme = urlParams.get('color');
                selectColorScheme(colorScheme);
            }
            
            if (urlParams.has('iter')) {
                maxIterations = parseInt(urlParams.get('iter'));
                document.getElementById('iterations').value = maxIterations;
                document.getElementById('iterValue').textContent = maxIterations;
            }
            
            if (urlParams.has('escape')) {
                escapeRadius = parseFloat(urlParams.get('escape'));
                document.getElementById('escapeRadius').value = escapeRadius;
                document.getElementById('escapeValue').textContent = escapeRadius;
            }
            
            if (urlParams.has('juliaR') && urlParams.has('juliaI')) {
                juliaCReal = parseFloat(urlParams.get('juliaR'));
                juliaCImag = parseFloat(urlParams.get('juliaI'));
                customJuliaReal = juliaCReal;
                customJuliaImag = juliaCImag;
                
                document.getElementById('juliaCReal').value = juliaCReal;
                document.getElementById('juliaCImag').value = juliaCImag;
                document.getElementById('juliaCRealValue').textContent = juliaCReal.toFixed(6);
                document.getElementById('customJuliaRealValue').textContent = juliaCReal.toFixed(6);
                document.getElementById('juliaCImagValue').textContent = juliaCImag.toFixed(6);
                document.getElementById('customJuliaImagValue').textContent = juliaCImag.toFixed(6);
                document.getElementById('complexDisplay').textContent = `Current: c = ${juliaCReal.toFixed(6)} + ${juliaCImag.toFixed(6)}i`;
            }
            
            if (urlParams.has('power')) {
                bulbPower = parseInt(urlParams.get('power'));
                document.getElementById('power').value = bulbPower;
                document.getElementById('powerValue').textContent = bulbPower;
            }
            
            if (urlParams.has('slice')) {
                sliceZ = parseFloat(urlParams.get('slice'));
                document.getElementById('sliceZ').value = sliceZ;
                document.getElementById('sliceZValue').textContent = sliceZ.toFixed(2);
            }
        }
        
        window.addEventListener('load', () => {
            setTimeout(() => {
                resizeCanvas();
                loadFromURL();
                
                // Show keyboard shortcuts help briefly on first load
                setTimeout(() => {
                    toggleShortcutsHelp();
                    setTimeout(toggleShortcutsHelp, 3000);
                }, 1000);
            }, 100);
        });
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => {
                    resizeCanvas();
                    loadFromURL();
                }, 100);
            });
        } else {
            setTimeout(() => {
                resizeCanvas();
                loadFromURL();
            }, 100);
        }
    </script>
</body>
</html>